name: PyShield Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  # Update this URL if self-hosting PyShield
  PYSHIELD_API: "https://api.pyshield.dev/api/v1"

  # Minimum severity to fail CI: critical, high, medium, low
  SEVERITY_THRESHOLD: "high"

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests packaging

      - name: Download PyShield scan script
        run: |
          # Download the scanning script from PyShield repository
          # Update this URL to match your deployment
          curl -fsSL -o scan.py https://raw.githubusercontent.com/your-org/pyshield/main/docs/examples/github-actions/scan.py

          # Alternative: Include scan.py in your repository
          # cp .github/scripts/pyshield-scan.py scan.py

      - name: Scan dependencies with PyShield
        id: scan
        run: |
          if [ -f requirements.txt ]; then
            python scan.py requirements.txt --threshold ${{ env.SEVERITY_THRESHOLD }} --api-url ${{ env.PYSHIELD_API }}
          else
            echo "No requirements.txt found. Skipping scan."
            exit 0
          fi
        continue-on-error: true

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pyshield-scan-results
          path: pyshield-*.json
          retention-days: 90

      - name: Check scan results
        if: steps.scan.outcome == 'failure'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ PyShield Security Scan FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Severity threshold: ${{ env.SEVERITY_THRESHOLD }}"
          echo "Packages with security issues exceeding threshold were found."
          echo ""
          echo "ğŸ“‹ Review the uploaded artifacts for detailed findings:"
          echo "   - Go to Actions â†’ This workflow run â†’ Artifacts"
          echo "   - Download 'pyshield-scan-results' for full report"
          echo ""
          echo "ğŸ”§ Recommended actions:"
          echo "   1. Review findings in the artifact JSON files"
          echo "   2. Update vulnerable dependencies"
          echo "   3. Re-run the workflow after fixes"
          echo ""
          exit 1

      - name: Success message
        if: steps.scan.outcome == 'success'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PyShield Security Scan PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "All dependencies meet security threshold: ${{ env.SEVERITY_THRESHOLD }}"
          echo ""

# Optional: Post results as PR comment (requires write permissions)
#
#      - name: Post PR comment with results
#        if: github.event_name == 'pull_request' && always()
#        uses: actions/github-script@v7
#        with:
#          script: |
#            const fs = require('fs');
#            const files = fs.readdirSync('.')
#                           .filter(f => f.startsWith('pyshield-scan-'));
#
#            if (files.length === 0) return;
#
#            const data = JSON.parse(fs.readFileSync(files[0], 'utf8'));
#            const summary = data.summary || 'No summary available';
#
#            github.rest.issues.createComment({
#              issue_number: context.issue.number,
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              body: `## ğŸ›¡ï¸ PyShield Security Scan Results\n\n${summary}`
#            });
